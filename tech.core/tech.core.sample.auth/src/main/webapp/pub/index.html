<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>API v3 static web application</title>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<!-- auth0.com -->
<script src="//cdn.auth0.com/w2/auth0-widget-5.2.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<script>
    function callAPI() {
        var endpoint = $("#host").val() + $("#endpoint").val() + $("#resource").val();
        $.ajax({
            url : endpoint,
            dataType : 'json',
            data: {fields: $("#fields").val(),
                   filter: $("#filter").val(),
                   limit: $("#limit").val(),
                   offset: $("#offset").val(),
                   offsetId: $("#offsetId").val(),
                   orderBy: $("#orderBy").val(),
                   include: $("#include").val(),
                },
            success : function(data) {
                console.log(data);
                $("#ajaxBox").html("<pre>" + syntaxHighlight(data) + "</pre>");
            },
        	error : function(xhr,status,error) {
        	    var context = "status:" + xhr.status + "<br/>context:<br/><pre>" + error + "</pre>";
                $("#ajaxBox").html(context);
        	}
        });
    }

    function decodeJwt() {
        var endpoint = $("#host").val() + "/pub/decode?token=" + localStorage.getItem("userJWTToken");
        $.ajax({
            type: "GET",
            url : endpoint,
            dataType : 'json',
            success : function(data) {
                var popup = window.open("", "", "location=yes, menubar=yes, toolbar=no");
                popup.document.write('<html><body>Decoded: <span id="status"></span></body></html>');
                popup.document.getElementById('status').innerHTML = '<pre>' + JSON.stringify(data, undefined, 2) + '</pre>';

            },
        	error : function(xhr,status,error) {
        	    var context = "status:" + xhr.status + "<br/>context:<br/><pre>" + error + "</pre>";
                window.confirm(context)
        	}
        });
    }

    function syntaxHighlight(json) {
        if (typeof json != 'string') {
            json = JSON.stringify(json, undefined, 2);
        }
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(
                        /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                        function(match) {
                            var cls = 'number';
                            if (/^"/.test(match)) {
                                if (/:$/.test(match)) {
                                    cls = 'key';
                                } else {
                                    cls = 'string';
                                }
                            } else if (/true|false/.test(match)) {
                                cls = 'boolean';
                            } else if (/null/.test(match)) {
                                cls = 'null';
                            }
                            return '<span class="' + cls + '">' + match + '</span>';
                        });
    }
    
    var AUTH0_DOMAIN = 'topcoder-dev.auth0.com';
    function reloadProfile() {
        $("#auth0_domain").text(AUTH0_DOMAIN);
        $("#auth0_token").text(localStorage.getItem('userJWTToken'));
    }
    
    $(document).ready(function() {

        $('.btn-login').click(function(e) {
          location.href = "./login?retUrl=" + location.href;
        });

        $('.btn-login-debug').click(function(e) {
            var new_location = "./login?debug=true&retUrl=" + location.href;
            alert("Redirecting to:\n" + new_location);
            location.href = new_location;
          });

        $('.btn-logout').click(function(e) {
            localStorage.removeItem('userJWTToken');
            localStorage.removeItem('userAuth0AccessToken');
            userProfile = null;
            location.reload(true);
        });

        $.ajaxSetup({
            'beforeSend': function(xhr) {
              if (localStorage.getItem('userJWTToken')) {
                xhr.setRequestHeader('Authorization',
                      'Bearer ' + localStorage.getItem('userJWTToken'));
              }
            }
          });
        
        reloadProfile();
    });
</script>
<style type="text/css">
<!--
pre {
  outline: 1px solid #ccc;
  padding: 5px;
  margin: 5px;
}
.string {
  color: green;
}
.number {
  color: darkorange;
}
.boolean {
  color: blue;
}
.null {
  color: magenta;
}
.key {
  color: red;
}
-->
</style>
</head>
<body>
  <h2>API Checker</h2>
  
  <div id="auth0_profile">
  <h3>Auth0 Profile</h3>
    <dl>
      <dt>domain:</dt><dd><div id="auth0_domain"/></dd>
      <dt>JWT token:</dt><dd><div id="auth0_token"/></dd>
      <dd><button type="button" onclick="decodeJwt()">decode</button></dd>
    </dl>
    <button type="button" class="btn-login" id="btn-login">Login</button>
    <button type="button" class="btn-login-debug" id="btn-login-debug">Login (debug)</button>
    <button type="button" class="btn-logout" id="btn-logout">Logout</button>
  </div>
  <h3>API endpoint</h3>
    <dl>
      <!-- <dt>host:</dt><dd><input type=text id="host" value="http://localhost:8080/tech.core.sample.auth" size=70/></dd> -->
      <dt>host:</dt><dd><input type=text id="host" value="http://api.topcoder-dev.com" size=70/></dd>
      <dt>endpoint:</dt><dd><input type=text id="endpoint" value="/api/v3/"/></dd>
      <dt>resource:</dt><dd><input type=text id="resource" value="users"/></dd>
      <dt>filter:</dt><dd><input type=text id="filter" size=70/></dd>
      <dt>limit:</dt><dd><input type=text id="limit"/></dd>
      <dt>offset:</dt><dd><input type=text id="offset"/></dd>
      <dt>orderBy:</dt><dd><input type=text id="orderBy"/></dd>
      <dt>fields:</dt><dd><input type=text id="fields" size=70/></dd>
      <dt>include:</dt><dd><input type=text id="fields" size=70/></dd>
    </dl>
    <button type="button" onclick="callAPI()">Call API with JWT</button>
  </div>
  <div id="ajaxBox"></div>
</body>
</html>